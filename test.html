<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR Wall Art</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    canvas { display: block; width: 100%; height: 100%; }
  </style>
</head>
<body class="bg-gray-100 text-center flex flex-col items-center justify-center min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4">Upload Art and Preview in AR</h1>

  <!-- Upload Button -->
  <label class="bg-indigo-600 text-white px-4 py-2 rounded cursor-pointer hover:bg-indigo-700">
    Choose Image
    <input type="file" accept="image/*" id="imageUpload" hidden />
  </label>
  <p id="dimensions" class="text-sm text-gray-600 mt-2"></p>
  <button id="startAR" class="mt-6 bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">Start AR</button>

  <!-- Message if AR not supported -->
  <p id="arMessage" class="mt-4 text-red-600 hidden">WebXR AR not supported on this device.</p>

  <!-- Three.js + WebXR -->
  <script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.164.0';
    import { ARButton } from 'https://cdn.skypack.dev/three@0.164.0/examples/jsm/webxr/ARButton.js';

    let camera, scene, renderer;
    let imageTexture = null;

    const imageUpload = document.getElementById('imageUpload');
    const dimensionsText = document.getElementById('dimensions');
    const startARBtn = document.getElementById('startAR');
    const arMessage = document.getElementById('arMessage');

    let imageDataUrl = null;

    // Handle image upload
    imageUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        imageDataUrl = event.target.result;
        const img = new Image();
        img.onload = () => {
          dimensionsText.textContent = `Image Size: ${img.width} x ${img.height}`;
        };
        img.src = imageDataUrl;
      };
      reader.readAsDataURL(file);
    });

    startARBtn.addEventListener('click', () => {
      if (!navigator.xr || !navigator.xr.isSessionSupported) {
        arMessage.classList.remove('hidden');
        return;
      }

      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        if (supported) {
          initAR();
        } else {
          arMessage.classList.remove('hidden');
        }
      });
    });

    function initAR() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera();

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // Load uploaded texture
      const loader = new THREE.TextureLoader();
      loader.load(imageDataUrl, (texture) => {
        const aspect = texture.image.width / texture.image.height;
        const width = 0.7; // meters
        const height = width / aspect;

        const geometry = new THREE.PlaneGeometry(width, height);
        const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.set(0, 0, -2); // In front of camera
        scene.add(mesh);
      });

      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    }
  </script>
</body>
</html>
